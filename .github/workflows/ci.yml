name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}/q:${{ github.workspace }}/aion
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -r q/requirements.txt
          pip install -r aion/requirements.txt
      - name: Lint with ruff
        run: ruff check q/ aion/
      - name: Type check (non-blocking)
        run: mypy q/qengine/ q/qmods/ --ignore-missing-imports || true
      - name: Run tests with coverage
        run: |
          pytest q/tests/ aion/tests/ --cov=q --cov=aion --cov-report=term-missing -x
      - name: Check for secrets
        run: |
          ! grep -rn "password\\|api_key\\|secret" q/ aion/ --include="*.py" | grep -v "test_\\|\\.env\\|example\\|getenv\\|environ"
